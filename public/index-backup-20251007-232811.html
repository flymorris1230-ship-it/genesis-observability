<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesis Observability | Unified Dashboard - Factory OS & LLM Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ========================================
           PHASE 2 OPTIMIZATIONS
           ======================================== */

        /* ✅ Phase 2: Enhanced Color Contrast (WCAG AAA) */
        :root {
            --color-primary: #3730a3; /* Darker indigo for better contrast */
            --color-primary-light: #4f46e5;
            --color-success: #047857; /* Darker green */
            --color-warning: #b45309; /* Darker orange */
            --color-error: #b91c1c; /* Darker red */
            --color-info: #1e40af; /* Darker blue */
            --color-text-primary: #111827; /* Almost black */
            --color-text-secondary: #374151; /* Dark gray */
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f9fafb;
        }

        /* ✅ Quick Win #1: Loading Skeletons */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-card {
            height: 150px;
        }

        /* ✅ Quick Win #2: Enhanced Focus Indicators */
        *:focus {
            outline: 3px solid var(--color-primary); /* Thicker for AAA */
            outline-offset: 3px;
        }

        *:focus:not(:focus-visible) {
            outline: none;
        }

        *:focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 3px;
            border-radius: 4px;
        }

        button:focus-visible,
        a:focus-visible {
            box-shadow: 0 0 0 4px rgba(55, 48, 163, 0.4);
        }

        @media (prefers-contrast: high) {
            *:focus-visible {
                outline: 4px solid #000;
                outline-offset: 4px;
            }
        }

        /* Screen reader only utility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .sr-only-focusable:focus {
            position: static;
            width: auto;
            height: auto;
            padding: inherit;
            margin: inherit;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #6b21a8 100%);
        }

        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            max-width: 28rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 1rem;
            z-index: 50;
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }

        .toast.toast-exit {
            transform: translateX(400px);
        }

        /* ✅ Phase 2: Mobile-specific toast positioning */
        @media (max-width: 640px) {
            .toast {
                top: auto;
                bottom: 1rem;
                left: 1rem;
                right: 1rem;
                max-width: calc(100% - 2rem);
            }

            .toast.toast-exit {
                transform: translateY(200px);
            }
        }

        /* ✅ Phase 2: Responsive Table - Card View on Mobile */
        @media (max-width: 768px) {
            .responsive-table {
                display: none;
            }

            .mobile-card-view {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .responsive-table {
                display: table;
            }

            .mobile-card-view {
                display: none;
            }
        }

        /* Mobile card styles */
        .mobile-agent-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .mobile-agent-card:hover {
            border-color: var(--color-primary);
        }

        /* ✅ Phase 2: Responsive Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 250px;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .chart-container {
                height: 280px;
            }
        }

        /* ✅ Phase 2: Better spacing on mobile */
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            h1 {
                font-size: 1.5rem !important;
            }

            h2 {
                font-size: 1.25rem !important;
            }

            .stat-card-value {
                font-size: 2rem !important;
            }
        }

        /* ✅ Phase 2: Tablet-specific optimizations */
        @media (min-width: 641px) and (max-width: 1024px) {
            .grid-tablet-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* ✅ Phase 2: Enhanced contrast for status badges */
        .status-completed {
            background-color: #d1fae5;
            color: #047857;
            font-weight: 600;
        }
        .status-in-progress {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }
        .status-planned {
            background-color: #f3f4f6;
            color: #374151;
            font-weight: 600;
        }
        .status-blocked {
            background-color: #fee2e2;
            color: #b91c1c;
            font-weight: 600;
        }
        .status-todo {
            background-color: #fef3c7;
            color: #b45309;
            font-weight: 600;
        }

        /* ✅ Phase 2: Improved button contrast */
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #312e81;
        }

        .btn-primary:active {
            background-color: #1e1b4b;
        }

        /* ✅ Phase 2: Better module progress bars */
        .progress-bar {
            transition: width 0.5s ease-in-out;
            min-width: 2px; /* Show even 0% progress */
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ✅ Quick Win #3: Skip Link -->
    <a href="#main-content"
       class="sr-only-focusable absolute top-0 left-0 bg-indigo-700 text-white px-4 py-2 z-50 font-semibold">
        Skip to main content
    </a>

    <!-- Header with ARIA -->
    <header role="banner" class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold mb-1" id="page-title">
                        <span aria-hidden="true">🚀</span>
                        <span>Genesis Observability Dashboard</span>
                    </h1>
                    <p class="text-indigo-100" role="doc-subtitle">
                        GAC Factory OS - Real-time Project Tracking
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right" role="status" aria-live="polite">
                        <div class="text-sm text-indigo-100" id="last-updated-label">
                            Last Updated
                        </div>
                        <time class="text-lg font-semibold"
                              id="last-updated"
                              aria-labelledby="last-updated-label">
                            Loading...
                        </time>
                    </div>
                    <button onclick="loadAllData()"
                            class="btn-primary shadow-lg"
                            aria-label="Refresh dashboard data">
                        <span aria-hidden="true">🔄</span>
                        <span class="hidden sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main role="main" id="main-content" aria-labelledby="page-title">
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <!-- Top Stats -->
            <section aria-label="Project statistics">
                <h2 class="sr-only">Project Statistics Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                    <!-- Overall Progress -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="overall-progress-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="overall-progress-title"
                                class="text-gray-700 text-xs sm:text-sm font-bold uppercase">
                                Overall Progress
                            </h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                📊
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="overall-progress"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-20"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="overall-modules"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-32"></div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-3"
                             role="progressbar"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100"
                             aria-labelledby="overall-progress-title">
                            <div id="overall-progress-bar"
                                 class="bg-indigo-600 h-2 rounded-full progress-bar"
                                 style="width: 0%"></div>
                        </div>
                    </article>

                    <!-- Current Sprint -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="sprint-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="sprint-title" class="text-gray-700 text-xs sm:text-sm font-bold uppercase">Current Sprint</h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                ⚡
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="sprint-name"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-16"></div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2"
                             id="sprint-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-28"></div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="sprint-progress-bar"
                                 class="bg-green-600 h-2 rounded-full progress-bar"
                                 style="width: 0%"></div>
                        </div>
                    </article>

                    <!-- AI Agents -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="agents-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="agents-title" class="text-gray-700 text-xs sm:text-sm font-bold uppercase">AI Agents</h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                🤖
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="agent-success-rate"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-20"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="agent-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-24"></div>
                        </div>
                    </article>

                    <!-- Features -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="features-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="features-title" class="text-gray-700 text-xs sm:text-sm font-bold uppercase">Features</h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                ✨
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="features-completed"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-24"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="features-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-32"></div>
                        </div>
                    </article>
                </div>
            </section>

            <!-- LLM Usage & Cost Monitoring -->
            <section aria-label="LLM usage and cost statistics" class="mb-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <span aria-hidden="true">💬</span> LLM Usage & Cost Monitoring
                    <span class="text-sm font-normal text-gray-500">(Last 7 Days)</span>
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                    <!-- Total Tokens -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="llm-tokens-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="llm-tokens-title"
                                class="text-gray-700 text-xs sm:text-sm font-bold uppercase">
                                Total Tokens
                            </h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                🔢
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="llm-total-tokens"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-20"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="llm-tokens-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-32"></div>
                        </div>
                    </article>

                    <!-- Total Cost -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="llm-cost-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="llm-cost-title" class="text-gray-700 text-xs sm:text-sm font-bold uppercase">Total Cost</h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-600 to-emerald-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                💰
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="llm-total-cost"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-16"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="llm-cost-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-28"></div>
                        </div>
                    </article>

                    <!-- API Requests -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="llm-requests-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="llm-requests-title" class="text-gray-700 text-xs sm:text-sm font-bold uppercase">API Requests</h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-violet-600 to-violet-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                📡
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="llm-total-requests"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-20"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="llm-requests-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-24"></div>
                        </div>
                    </article>

                    <!-- Average Latency -->
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 card-hover fade-in"
                             aria-labelledby="llm-latency-title">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="llm-latency-title" class="text-gray-700 text-xs sm:text-sm font-bold uppercase">Avg Latency</h3>
                            <div class="w-10 h-10 bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg flex items-center justify-center text-white text-xl"
                                 aria-hidden="true">
                                ⚡
                            </div>
                        </div>
                        <div class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 stat-card-value"
                             id="llm-avg-latency"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-24"></div>
                        </div>
                        <div class="text-sm text-gray-600"
                             id="llm-latency-details"
                             role="status"
                             aria-live="polite">
                            <div class="skeleton skeleton-text w-32"></div>
                        </div>
                    </article>
                </div>
            </section>

            <!-- Module Progress -->
            <section aria-label="Module progress" class="mb-8">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center gap-2">
                        <span aria-hidden="true">📦</span> Module Progress
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6" id="modules-container">
                        <!-- Loading skeletons -->
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Charts -->
            <section aria-label="Data visualizations">
                <h2 class="sr-only">Charts and Visualizations</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8 grid-tablet-2">
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in"
                             aria-labelledby="task-chart-title">
                        <h3 id="task-chart-title"
                            class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span aria-hidden="true">📋</span> Task Distribution
                        </h3>
                        <div class="chart-container">
                            <canvas id="taskChart"
                                    role="img"
                                    aria-label="Task distribution by status - doughnut chart"></canvas>
                        </div>
                    </article>

                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in"
                             aria-labelledby="agent-chart-title">
                        <h3 id="agent-chart-title"
                            class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span aria-hidden="true">🤖</span> Agent Success Rates
                        </h3>
                        <div class="chart-container">
                            <canvas id="agentChart"
                                    role="img"
                                    aria-label="Agent success rates - bar chart"></canvas>
                        </div>
                    </article>
                </div>
            </section>

            <!-- LLM Usage Charts -->
            <section aria-label="LLM usage visualizations" class="mb-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <span aria-hidden="true">📊</span> LLM Usage Analytics
                </h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8">
                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in"
                             aria-labelledby="llm-trend-chart-title">
                        <h3 id="llm-trend-chart-title"
                            class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span aria-hidden="true">📈</span> Token Usage Trend (7 Days)
                        </h3>
                        <div class="chart-container">
                            <canvas id="llmTrendChart"
                                    role="img"
                                    aria-label="LLM token usage trend over 7 days - line chart"></canvas>
                        </div>
                    </article>

                    <article class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in"
                             aria-labelledby="llm-cost-chart-title">
                        <h3 id="llm-cost-chart-title"
                            class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span aria-hidden="true">💵</span> Cost by Provider
                        </h3>
                        <div class="chart-container">
                            <canvas id="llmCostChart"
                                    role="img"
                                    aria-label="LLM cost breakdown by provider - bar chart"></canvas>
                        </div>
                    </article>
                </div>
            </section>

            <!-- LLM Model Distribution Table -->
            <section aria-label="LLM model usage details" class="mb-8">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span aria-hidden="true">🔍</span> Model Distribution (Last 7 Days)
                    </h2>

                    <!-- Desktop Table View -->
                    <div class="overflow-x-auto responsive-table">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Model</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Provider</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Requests</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Tokens</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Cost (USD)</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Avg Latency</th>
                                </tr>
                            </thead>
                            <tbody id="llm-models-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                        <div class="skeleton skeleton-card"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Card View -->
                    <div id="llm-models-mobile" class="mobile-card-view space-y-3">
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Tasks List (Responsive) -->
            <section aria-label="All tasks" class="mb-8">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span aria-hidden="true">📝</span> All Tasks
                    </h2>
                    <div id="tasks-container" class="space-y-3 sm:space-y-4">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- Agent Table (Responsive) -->
            <section aria-label="AI agent status" class="mb-8">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span aria-hidden="true">👥</span> AI Agent Status
                    </h2>

                    <!-- Desktop Table View -->
                    <div class="overflow-x-auto">
                        <table class="w-full responsive-table" role="table">
                            <thead>
                                <tr class="border-b-2 border-gray-300">
                                    <th scope="col" class="text-left py-3 px-4 text-sm font-bold text-gray-700">Agent Name</th>
                                    <th scope="col" class="text-center py-3 px-4 text-sm font-bold text-gray-700">Executions</th>
                                    <th scope="col" class="text-center py-3 px-4 text-sm font-bold text-gray-700">Success Rate</th>
                                    <th scope="col" class="text-center py-3 px-4 text-sm font-bold text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="agent-table-body">
                                <tr>
                                    <td colspan="4" class="text-center py-8">
                                        <div class="skeleton skeleton-text w-full"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile Card View -->
                    <div class="mobile-card-view" id="agent-cards-container">
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </section>

            <!-- System Health -->
            <section aria-label="System health">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 fade-in">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span aria-hidden="true">💚</span> System Health
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg" id="health-api">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full pulse-dot"
                                     role="status"
                                     aria-label="API status indicator"></div>
                                <div class="text-sm font-bold text-gray-800">API Health</div>
                            </div>
                            <div class="text-2xl font-bold text-gray-900">
                                <div class="skeleton skeleton-text w-16"></div>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">endpoints</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg" id="health-database">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full pulse-dot"
                                     role="status"
                                     aria-label="Database status indicator"></div>
                                <div class="text-sm font-bold text-gray-800">Database</div>
                            </div>
                            <div class="text-2xl font-bold text-gray-900">
                                <div class="skeleton skeleton-text w-16"></div>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">avg query time</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg" id="health-integration">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full pulse-dot"
                                     role="status"
                                     aria-label="Integration status indicator"></div>
                                <div class="text-sm font-bold text-gray-800">Integrations</div>
                            </div>
                            <div class="text-2xl font-bold text-gray-900">
                                <div class="skeleton skeleton-text w-16"></div>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">services</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer role="contentinfo" class="gradient-bg text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-indigo-100 text-sm sm:text-base">Genesis Observability Dashboard v2.2.0 (Phase 2 Optimized) | Real-time Project Tracking</p>
            <p class="text-indigo-200 text-xs sm:text-sm mt-2">
                Powered by Cloudflare Workers | Enhanced with MCP AI Analysis | WCAG AAA Compliant
            </p>
        </div>
    </footer>

    <script>
        // Configuration
        const API_BASE = 'https://obs-edge.flymorris1230.workers.dev';
        const API_KEY = 'a590aec22adeab9bb9fcf8ff81ccf790a588a298edeffce3216b317c18f87f9e';
        const PROJECT_ID = 'GAC_FactoryOS';

        let taskChart = null;
        let agentChart = null;
        let isRefreshing = false;

        // ✅ Quick Win #4: Toast Notification System
        function showToast({ type, title, message, duration = 5000 }) {
            const toast = document.createElement('div');
            toast.className = 'toast';

            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };

            const colors = {
                success: 'bg-green-50 text-green-900 border-2 border-green-600',
                error: 'bg-red-50 text-red-900 border-2 border-red-600',
                warning: 'bg-yellow-50 text-yellow-900 border-2 border-yellow-600',
                info: 'bg-blue-50 text-blue-900 border-2 border-blue-600'
            };

            toast.innerHTML = `
                <div class="flex items-start gap-3 ${colors[type]}" role="alert" aria-live="assertive">
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center font-bold text-xl">
                        ${icons[type]}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold">${title}</h4>
                        <p class="text-sm mt-1">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()"
                            class="hover:opacity-70 font-bold text-xl"
                            aria-label="Close notification">
                        ×
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Announce updates to screen readers
        function announceUpdate(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.className = 'sr-only';
            announcement.textContent = message;

            document.body.appendChild(announcement);

            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        // Enhanced fetch with error handling
        async function fetchAPI(endpoint) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);

                if (error.name === 'AbortError') {
                    showToast({
                        type: 'error',
                        title: 'Request Timeout',
                        message: 'The request took too long. Please try again.',
                        duration: 5000
                    });
                } else {
                    showToast({
                        type: 'error',
                        title: 'Connection Error',
                        message: 'Unable to fetch data. Retrying...',
                        duration: 3000
                    });
                }

                return null;
            }
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            const element = document.getElementById('last-updated');
            if (element) {
                element.textContent = now.toLocaleTimeString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }

        // Update Overview
        async function updateOverview() {
            const data = await fetchAPI(`/progress/overview?project_id=${PROJECT_ID}`);
            if (!data) return;

            const overview = data.overview;

            document.getElementById('overall-progress').textContent = `${overview.overall_progress}%`;
            document.getElementById('overall-modules').textContent =
                `${overview.modules.in_progress}/${overview.modules.total} in progress`;
            document.getElementById('overall-progress-bar').style.width = `${overview.overall_progress}%`;

            if (overview.current_sprint) {
                const sprint = overview.current_sprint;
                document.getElementById('sprint-name').textContent = `Day ${sprint.day}`;
                document.getElementById('sprint-details').textContent =
                    `${sprint.completed_tasks}/${sprint.total_tasks} tasks (${sprint.progress}%)`;
                document.getElementById('sprint-progress-bar').style.width = `${sprint.progress}%`;
            }

            announceUpdate(`Dashboard updated: Overall progress is ${overview.overall_progress} percent`);
            updateTimestamp();
        }

        // Update Modules
        async function updateModules() {
            const data = await fetchAPI(`/progress/modules?project_id=${PROJECT_ID}`);
            if (!data) return;

            document.getElementById('features-completed').textContent =
                `${data.summary.completed_features}/${data.summary.total_features}`;
            document.getElementById('features-details').textContent =
                `${data.summary.in_progress_features} in progress`;

            const container = document.getElementById('modules-container');
            container.innerHTML = '';

            const colorMap = {
                'WMS': { bg: 'indigo', textColor: 'text-indigo-700', bgColor: 'bg-indigo-600', icon: '📦' },
                'MES': { bg: 'green', textColor: 'text-green-700', bgColor: 'bg-green-600', icon: '⚙️' },
                'QMS': { bg: 'yellow', textColor: 'text-yellow-700', bgColor: 'bg-yellow-600', icon: '✓' },
                'R&D': { bg: 'purple', textColor: 'text-purple-700', bgColor: 'bg-purple-600', icon: '🔬' }
            };

            const statusClasses = {
                'completed': 'status-completed',
                'in_progress': 'status-in-progress',
                'planned': 'status-planned',
                'blocked': 'status-blocked'
            };

            data.modules.forEach(module => {
                const config = colorMap[module.module] || { bg: 'gray', textColor: 'text-gray-700', bgColor: 'bg-gray-600', icon: '📄' };

                const moduleCard = `
                    <article class="p-4 border-2 border-gray-300 rounded-lg hover:border-indigo-600 transition">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex-1">
                                <div class="text-base sm:text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <span aria-hidden="true">${config.icon}</span> ${module.module}
                                </div>
                                <div class="text-xs text-gray-600 mt-1">${module.metadata.description}</div>
                            </div>
                            <div class="text-2xl font-bold ${config.textColor} ml-2">${module.progress_percentage}%</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2"
                             role="progressbar"
                             aria-label="${module.module} progress"
                             aria-valuenow="${module.progress_percentage}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            <div class="${config.bgColor} h-3 rounded-full progress-bar"
                                 style="width: ${module.progress_percentage}%"></div>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-700 font-semibold">${module.features.completed}/${module.features.total} features</span>
                            <span class="px-2 py-1 rounded-full text-xs ${statusClasses[module.status] || 'status-planned'}">
                                ${module.status.replace('_', ' ')}
                            </span>
                        </div>
                    </article>
                `;
                container.innerHTML += moduleCard;
            });
        }

        // Update Tasks
        async function updateTasks() {
            const data = await fetchAPI(`/tasks?project_id=${PROJECT_ID}`);
            if (!data) return;

            // Update chart
            updateTaskChart(data);

            // Update task list
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';

            const moduleGroups = {};
            data.tasks.forEach(task => {
                if (!moduleGroups[task.module]) {
                    moduleGroups[task.module] = [];
                }
                moduleGroups[task.module].push(task);
            });

            const statusClasses = {
                'completed': 'status-completed',
                'in_progress': 'status-in-progress',
                'todo': 'status-todo',
                'blocked': 'status-blocked',
                'planned': 'status-planned'
            };

            Object.keys(moduleGroups).forEach(moduleName => {
                const tasks = moduleGroups[moduleName];
                const moduleSection = `
                    <div class="border-2 border-gray-300 rounded-lg p-4">
                        <h3 class="font-bold text-gray-900 mb-3 text-base sm:text-lg">${moduleName}</h3>
                        <div class="space-y-2">
                            ${tasks.map(task => `
                                <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900 text-sm">${task.name}</div>
                                        <div class="text-xs text-gray-600 mt-1">${task.description || 'No description'}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs ${statusClasses[task.status] || 'status-planned'} whitespace-nowrap">
                                        ${task.status.replace('_', ' ')}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += moduleSection;
            });
        }

        // Update Agents (Table + Cards)
        async function updateAgents() {
            const data = await fetchAPI(`/agents?project_id=${PROJECT_ID}`);
            if (!data) return;

            // Calculate success rate
            const totalExecs = data.agents.reduce((sum, a) => sum + a.total_executions, 0);
            const successfulExecs = data.agents.reduce((sum, a) => sum + a.successful_executions, 0);
            const successRate = totalExecs > 0 ? Math.round((successfulExecs / totalExecs) * 100) : 0;

            document.getElementById('agent-success-rate').textContent = `${successRate}%`;
            document.getElementById('agent-details').textContent = `${data.agents.length} active agents`;

            // Update chart
            updateAgentChart(data);

            // Desktop table
            const tbody = document.getElementById('agent-table-body');
            tbody.innerHTML = '';

            // Mobile cards
            const cardsContainer = document.getElementById('agent-cards-container');
            cardsContainer.innerHTML = '';

            data.agents.forEach(agent => {
                const rate = agent.total_executions > 0
                    ? Math.round((agent.successful_executions / agent.total_executions) * 100)
                    : 0;

                let statusClass = 'status-completed';
                let statusText = 'Excellent';
                if (rate < 50) {
                    statusClass = 'status-blocked';
                    statusText = 'Needs Review';
                } else if (rate < 75) {
                    statusClass = 'status-in-progress';
                    statusText = 'Good';
                }

                // Table row
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm font-semibold text-gray-900">${agent.agent_name}</td>
                        <td class="py-3 px-4 text-center text-sm text-gray-700">${agent.total_executions}</td>
                        <td class="py-3 px-4 text-center text-sm font-semibold text-gray-900">${rate}%</td>
                        <td class="py-3 px-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;

                // Mobile card
                const card = `
                    <div class="mobile-agent-card">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-bold text-gray-900">${agent.agent_name}</div>
                            <span class="px-3 py-1 rounded-full text-xs ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <div class="text-gray-600 text-xs">Executions</div>
                                <div class="font-semibold text-gray-900">${agent.total_executions}</div>
                            </div>
                            <div>
                                <div class="text-gray-600 text-xs">Success Rate</div>
                                <div class="font-semibold text-gray-900">${rate}%</div>
                            </div>
                        </div>
                    </div>
                `;
                cardsContainer.innerHTML += card;
            });
        }

        // Update System Health
        async function updateHealth() {
            const [apiHealth, dbHealth, integrationHealth] = await Promise.all([
                fetchAPI('/health/api'),
                fetchAPI('/health/database'),
                fetchAPI('/health/integrations')
            ]);

            if (apiHealth) {
                const apiDiv = document.getElementById('health-api');
                const operational = apiHealth.endpoints.filter(e => e.operational).length;
                apiDiv.querySelector('.text-2xl').textContent = `${operational}/${apiHealth.endpoints.length}`;
                apiDiv.querySelector('.pulse-dot').className =
                    `w-3 h-3 ${operational === apiHealth.endpoints.length ? 'bg-green-600' : 'bg-yellow-600'} rounded-full pulse-dot`;
            }

            if (dbHealth) {
                const dbDiv = document.getElementById('health-database');
                dbDiv.querySelector('.text-2xl').textContent = `${dbHealth.avg_query_time_ms}ms`;
                dbDiv.querySelector('.pulse-dot').className =
                    `w-3 h-3 ${dbHealth.avg_query_time_ms < 100 ? 'bg-green-600' : 'bg-yellow-600'} rounded-full pulse-dot`;
            }

            if (integrationHealth) {
                const intDiv = document.getElementById('health-integration');
                const operational = integrationHealth.integrations.filter(i => i.operational).length;
                intDiv.querySelector('.text-2xl').textContent = `${operational}/${integrationHealth.integrations.length}`;
                intDiv.querySelector('.pulse-dot').className =
                    `w-3 h-3 ${operational === integrationHealth.integrations.length ? 'bg-green-600' : 'bg-red-600'} rounded-full pulse-dot`;
            }
        }

        // ✅ Phase 2: Responsive Chart Configuration
        function updateTaskChart(data) {
            const ctx = document.getElementById('taskChart');
            if (!ctx) return;

            if (taskChart) {
                taskChart.destroy();
                taskChart = null;
            }

            const statusCount = {};
            data.tasks.forEach(task => {
                statusCount[task.status] = (statusCount[task.status] || 0) + 1;
            });

            const isMobile = window.innerWidth < 640;

            taskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCount).map(s => s.replace('_', ' ')),
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: ['#047857', '#1e40af', '#6b7280', '#b91c1c', '#b45309'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'top' : 'bottom',
                            labels: {
                                padding: isMobile ? 10 : 15,
                                font: { size: isMobile ? 10 : 12 },
                                color: '#111827'
                            }
                        }
                    }
                }
            });
        }

        function updateAgentChart(data) {
            const ctx = document.getElementById('agentChart');
            if (!ctx) return;

            if (agentChart) {
                agentChart.destroy();
                agentChart = null;
            }

            const isMobile = window.innerWidth < 640;

            agentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.agents.map(a => a.agent_name.split(' ')[0]), // Shorter labels
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: data.agents.map(a =>
                            a.total_executions > 0
                                ? Math.round((a.successful_executions / a.total_executions) * 100)
                                : 0
                        ),
                        backgroundColor: '#4f46e5',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                font: { size: isMobile ? 10 : 12 },
                                color: '#374151'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: isMobile ? 9 : 11 },
                                color: '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: !isMobile,
                            labels: {
                                font: { size: 12 },
                                color: '#111827'
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // LLM MONITORING FUNCTIONS
        // ========================================

        let llmTrendChart, llmCostChart;

        // Update LLM overview stats
        async function updateLLMOverview() {
            try {
                // Get date range for last 7 days
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                const data = await fetchAPI(`/metrics?project_id=GAC_FactoryOS&start_date=${startDate}&end_date=${endDate}`);

                // Update stat cards
                document.getElementById('llm-total-tokens').textContent =
                    (data.totalTokens || 0).toLocaleString();
                document.getElementById('llm-tokens-details').textContent =
                    `${(data.inputTokens || 0).toLocaleString()} in / ${(data.outputTokens || 0).toLocaleString()} out`;

                document.getElementById('llm-total-cost').textContent =
                    `$${(data.totalCost || 0).toFixed(2)}`;
                document.getElementById('llm-cost-details').textContent =
                    `Avg: $${(data.averageCostPerRequest || 0).toFixed(4)}/req`;

                document.getElementById('llm-total-requests').textContent =
                    (data.totalRequests || 0).toLocaleString();
                document.getElementById('llm-requests-details').textContent =
                    `${Math.round((data.totalRequests || 0) / 7)} requests/day avg`;

                document.getElementById('llm-avg-latency').textContent =
                    `${Math.round(data.averageLatency || 0)}ms`;
                document.getElementById('llm-latency-details').textContent =
                    data.averageLatency > 2000 ? '⚠️ High latency' : '✅ Good performance';

            } catch (error) {
                console.error('LLM overview error:', error);
                document.getElementById('llm-total-tokens').textContent = 'Error';
                document.getElementById('llm-total-cost').textContent = 'Error';
                document.getElementById('llm-total-requests').textContent = 'Error';
                document.getElementById('llm-avg-latency').textContent = 'Error';
            }
        }

        // Update LLM charts and model distribution
        async function updateLLMCharts() {
            try {
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                // Fetch metrics and costs data
                const [metricsData, costsData] = await Promise.all([
                    fetchAPI(`/metrics?project_id=GAC_FactoryOS&start_date=${startDate}&end_date=${endDate}`),
                    fetchAPI(`/costs?project_id=GAC_FactoryOS&start_date=${startDate}&end_date=${endDate}`)
                ]);

                // 1. Token Usage Trend Chart (Line Chart)
                if (llmTrendChart) llmTrendChart.destroy();
                const trendCtx = document.getElementById('llmTrendChart');
                llmTrendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: metricsData.dailyMetrics?.map(d => new Date(d.date).toLocaleDateString()) || [],
                        datasets: [{
                            label: 'Total Tokens',
                            data: metricsData.dailyMetrics?.map(d => d.totalTokens) || [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.parsed.y.toLocaleString()} tokens`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => value.toLocaleString()
                                }
                            }
                        }
                    }
                });

                // 2. Cost by Provider Chart (Bar Chart)
                if (llmCostChart) llmCostChart.destroy();
                const costCtx = document.getElementById('llmCostChart');
                llmCostChart = new Chart(costCtx, {
                    type: 'bar',
                    data: {
                        labels: costsData.byProvider?.map(p => p.provider) || [],
                        datasets: [{
                            label: 'Cost (USD)',
                            data: costsData.byProvider?.map(p => p.totalCost) || [],
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',  // Anthropic - indigo
                                'rgba(34, 197, 94, 0.8)',   // OpenAI - green
                                'rgba(245, 158, 11, 0.8)'   // Google - amber
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `$${context.parsed.y.toFixed(4)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => `$${value.toFixed(2)}`
                                }
                            }
                        }
                    }
                });

                // 3. Model Distribution Table
                updateLLMModelsTable(costsData.byModel || []);

            } catch (error) {
                console.error('LLM charts error:', error);
            }
        }

        // Update LLM models table (desktop and mobile views)
        function updateLLMModelsTable(models) {
            // Desktop table
            const tableBody = document.getElementById('llm-models-table-body');
            if (models.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No LLM usage data available</td></tr>';
            } else {
                tableBody.innerHTML = models.map(model => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${model.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${model.provider}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${(model.requestCount || 0).toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${(model.totalTokens || 0).toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">$${(model.totalCost || 0).toFixed(4)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${Math.round(model.avgLatency || 0)}ms</td>
                    </tr>
                `).join('');
            }

            // Mobile cards
            const mobileContainer = document.getElementById('llm-models-mobile');
            if (models.length === 0) {
                mobileContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No LLM usage data available</div>';
            } else {
                mobileContainer.innerHTML = models.map(model => `
                    <div class="mobile-agent-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-bold text-gray-900">${model.model}</div>
                                <div class="text-sm text-gray-600">${model.provider}</div>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${(model.requestCount || 0).toLocaleString()} reqs
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-sm">
                            <div>
                                <div class="text-gray-600">Tokens</div>
                                <div class="font-semibold text-gray-900">${(model.totalTokens || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Cost</div>
                                <div class="font-semibold text-gray-900">$${(model.totalCost || 0).toFixed(4)}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Latency</div>
                                <div class="font-semibold text-gray-900">${Math.round(model.avgLatency || 0)}ms</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Load all data with overlap prevention
        async function loadAllData() {
            if (isRefreshing) {
                showToast({
                    type: 'info',
                    title: 'Refresh In Progress',
                    message: 'Please wait for the current refresh to complete.',
                    duration: 2000
                });
                return;
            }

            isRefreshing = true;

            try {
                await Promise.all([
                    updateOverview(),
                    updateModules(),
                    updateTasks(),
                    updateAgents(),
                    updateHealth(),
                    updateLLMOverview(),
                    updateLLMCharts()
                ]);

                showToast({
                    type: 'success',
                    title: 'Dashboard Updated',
                    message: 'All data has been refreshed successfully.',
                    duration: 2000
                });
            } catch (error) {
                console.error('Load error:', error);
                showToast({
                    type: 'error',
                    title: 'Update Failed',
                    message: 'Some data could not be loaded. Please try again.',
                    duration: 5000
                });
            } finally {
                isRefreshing = false;
            }
        }

        // ✅ Phase 2: Reload charts on window resize for responsiveness
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(async () => {
                const taskData = await fetchAPI(`/tasks?project_id=${PROJECT_ID}`);
                const agentData = await fetchAPI(`/agents?project_id=${PROJECT_ID}`);
                if (taskData) updateTaskChart(taskData);
                if (agentData) updateAgentChart(agentData);
                // Reload LLM charts for responsiveness
                updateLLMCharts();
            }, 300);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (taskChart) taskChart.destroy();
            if (agentChart) agentChart.destroy();
            if (llmTrendChart) llmTrendChart.destroy();
            if (llmCostChart) llmCostChart.destroy();
        });

        // Initialize
        window.addEventListener('load', () => {
            loadAllData();
            setInterval(loadAllData, 30000);

            showToast({
                type: 'success',
                title: 'Dashboard Loaded',
                message: 'Welcome to Genesis Observability Dashboard!',
                duration: 3000
            });
        });
    </script>
</body>
</html>
